package com.tempandroidsandbox

import android.content.Context
import android.content.pm.PackageManager
import android.util.Log

/**
 * MalwareDetector - Signature-based malware detection system
 * Analyzes apps for known malicious patterns and suspicious behaviors
 */
class MalwareDetector(private val context: Context) {

    companion object {
        private const val TAG = "MalwareDetector"

        // Known malicious package name patterns (simplified for demo)
        private val SUSPICIOUS_PACKAGE_PATTERNS = listOf(
            "com.spy",
            "com.track",
            "com.hidden",
            "com.stealth",
            "keylogger",
            "spyware",
            "malware",
            "trojan",
            "ransomware"
        )

        // Dangerous permission combinations that indicate potential malware
        private val MALWARE_PERMISSION_COMBOS = listOf(
            // Spyware indicators
            setOf("android.permission.RECORD_AUDIO", "android.permission.INTERNET"),
            setOf("android.permission.CAMERA", "android.permission.INTERNET", "android.permission.RECORD_AUDIO"),
            // SMS trojans
            setOf("android.permission.SEND_SMS", "android.permission.RECEIVE_SMS", "android.permission.INTERNET"),
            // Data stealers
            setOf("android.permission.READ_CONTACTS", "android.permission.READ_SMS", "android.permission.INTERNET"),
            // Location trackers
            setOf("android.permission.ACCESS_FINE_LOCATION", "android.permission.INTERNET", "android.permission.RECEIVE_BOOT_COMPLETED"),
            // Banking trojans patterns
            setOf("android.permission.SYSTEM_ALERT_WINDOW", "android.permission.BIND_ACCESSIBILITY_SERVICE"),
            // Ransomware patterns
            setOf("android.permission.WRITE_EXTERNAL_STORAGE", "android.permission.SYSTEM_ALERT_WINDOW")
        )

        // Suspicious individual permissions
        private val SUSPICIOUS_PERMISSIONS = listOf(
            "android.permission.BIND_DEVICE_ADMIN",
            "android.permission.BIND_ACCESSIBILITY_SERVICE",
            "android.permission.SYSTEM_ALERT_WINDOW",
            "android.permission.WRITE_SETTINGS",
            "android.permission.REQUEST_INSTALL_PACKAGES",
            "android.permission.REQUEST_DELETE_PACKAGES"
        )
    }

    /**
     * Perform full malware analysis on an app
     */
    fun analyzeApp(packageName: String): Map<String, Any> {
        val pm: PackageManager = context.packageManager

        return try {
            val packageInfo = pm.getPackageInfo(packageName, PackageManager.GET_PERMISSIONS)
            val permissions = packageInfo.requestedPermissions?.toSet() ?: emptySet()
            val appInfo = pm.getApplicationInfo(packageName, 0)
            val appName = pm.getApplicationLabel(appInfo).toString()

            // Check for suspicious package name patterns
            val suspiciousNameMatch = SUSPICIOUS_PACKAGE_PATTERNS.any { pattern ->
                packageName.lowercase().contains(pattern) || appName.lowercase().contains(pattern)
            }

            // Check for dangerous permission combinations
            val matchedCombos = MALWARE_PERMISSION_COMBOS.filter { combo ->
                combo.all { perm -> permissions.contains(perm) }
            }

            // Check for suspicious individual permissions
            val suspiciousPerms = permissions.filter { it in SUSPICIOUS_PERMISSIONS }

            // Calculate threat score (0-100)
            var threatScore = 0
            if (suspiciousNameMatch) threatScore += 40
            threatScore += matchedCombos.size * 20
            threatScore += suspiciousPerms.size * 10
            threatScore = minOf(100, threatScore)

            // Determine threat level
            val threatLevel = when {
                threatScore >= 60 -> "THREAT"
                threatScore >= 30 -> "WARNING"
                else -> "SAFE"
            }

            // Build threat indicators list
            val indicators = mutableListOf<String>()
            if (suspiciousNameMatch) indicators.add("Suspicious app name pattern")
            if (matchedCombos.isNotEmpty()) indicators.add("Dangerous permission combinations detected")
            if (suspiciousPerms.isNotEmpty()) indicators.add("Suspicious system permissions requested")
            if (permissions.contains("android.permission.BIND_ACCESSIBILITY_SERVICE")) {
                indicators.add("Accessibility service access (can read screen content)")
            }
            if (permissions.contains("android.permission.SYSTEM_ALERT_WINDOW")) {
                indicators.add("Can draw over other apps (overlay attacks)")
            }
            if (permissions.contains("android.permission.BIND_DEVICE_ADMIN")) {
                indicators.add("Device admin access requested")
            }

            mapOf(
                "packageName" to packageName,
                "appName" to appName,
                "threatLevel" to threatLevel,
                "threatScore" to threatScore,
                "suspiciousNameMatch" to suspiciousNameMatch,
                "matchedComboCount" to matchedCombos.size,
                "suspiciousPermissions" to suspiciousPerms.toList(),
                "suspiciousPermCount" to suspiciousPerms.size,
                "indicators" to indicators,
                "indicatorCount" to indicators.size,
                "isSafe" to (threatLevel == "SAFE"),
                "scanTimestamp" to System.currentTimeMillis()
            )
        } catch (e: Exception) {
            Log.e(TAG, "Error analyzing malware for $packageName: ${e.message}")
            mapOf(
                "packageName" to packageName,
                "appName" to packageName,
                "threatLevel" to "UNKNOWN",
                "threatScore" to 0,
                "suspiciousNameMatch" to false,
                "matchedComboCount" to 0,
                "suspiciousPermissions" to emptyList<String>(),
                "suspiciousPermCount" to 0,
                "indicators" to listOf("Unable to analyze app"),
                "indicatorCount" to 1,
                "isSafe" to false,
                "scanTimestamp" to System.currentTimeMillis()
            )
        }
    }

    /**
     * Quick scan - returns just the threat level
     */
    fun quickScan(packageName: String): String {
        val result = analyzeApp(packageName)
        return result["threatLevel"] as String
    }
}
